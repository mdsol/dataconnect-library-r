---
title: "Data Connect Library - Usage"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Data Connect Library - Usage}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

***To set up Data Connect Library, please follow these [instructions](rLibrary_setup.html).***

### Preparation

Please restart R session in RStudio before proceeding, if you have just installed the dataconnect R library and set up the conda environment.

```{r}
# we recommend store userToken in a separate file in your working directory
# this is the user authentication token generated from the Developer Center in iMedidata Platform

userToken = "usertoken"
```

```{r}
# load prerequisite libraries
library(tidyverse)
```

### Initialize Data Connect connection

```{r}
library(dataconnect)
use_miniforge_env()
  
dc <-init(
  token = userToken)

```

### Work with datasets with `dataconnect` library

#### Search datasets in a study environment

Retrieve the study and study environment information from "Developer info" in iMedidata Platform.

```{r}

PWBStudy = list(
  PWBStudyId = "studyid",
  PWBPRODEnvID = "studyenvironmentid"
)

ExciterStudy = list (
  ExciterStudyId = "studyid",
  ExciterPRODEnvID = "studyenvironmentid"
)
```

set search keyword

```{r}
searchName = "datasetname"
```

search for a dataset in a specific study environment

```{r}
count <- 0
datasets <- dc$datasets(
  study_uuid = ExciterStudy$ExciterStudyId,
  study_environment_uuid= ExciterStudy$ExciterPRODEnvID,
  search_dataset_name= searchName)

# Process them lazily across all pages with one call
results <- datasets %::% {
  count <<- count + 1
  
  cat("## Dataset ", count, "\n\n")
  # to_frame is a helper for pretty printing the data elements out
  table_output <- to_frame(data)
  
  print(table_output)

  flush.console()

  data
}

# Display the total number of items processed
print(paste("Total datasets:", count))
```

#### Identify different versions of a specific dataset

Prepare a list of datasets that are needed.

```{r}
# datasetid can be retrieved from search datasets()
datasetid = list(
  PWBDerID = "datasetid",
  PWBImportID = "datasetid",
  PWBRaveID = "datasetid",
  PWBCustomID = "datasetid",
  ExciterDerID = "datasetid",
  ExciterImportID = "datasetid",
  ExciterRaveID = "datasetid",
  ExciterCustomID = "datasetid"
)
```

Retrieve other dataset versions if they are available

```{r}
dataset_versions <- dc$dataset_versions(
  study_uuid= ExciterStudy$ExciterStudyId,
  study_environment_uuid= ExciterStudy$ExciterPRODEnvID,
  dataset_uuid = datasetid$ExciterCustomID)

for(dataset_version in dataset_versions) {
  print(to_frame(dataset_version))
}
```

#### Fetch records for specific datasets

```{r}
RAVEdata <- dc$fetch_data(
                study_uuid = ExciterStudy$ExciterStudyId,
                study_environment_uuid = ExciterStudy$ExciterPRODEnvID,
                dataset_uuid = datasetid$ExciterRaveID
)
# Fetching first 3 rows of data
RAVEdata$frame %>% head(3)
```

```{r}
Derdata <- dc$fetch_data(
                study_uuid = PWBStudy$PWBStudyId,
                study_environment_uuid = PWBStudy$PWBPRODEnvID,
                dataset_uuid = datasetid$PWBDerID
)
# Fetching the first 6 rows of data
Derdata$frame %>% head()
```

```{r}
ImportData <- dc$fetch_data(
                study_uuid = PWBStudy$PWBStudyId,
                study_environment_uuid = PWBStudy$PWBPRODEnvID,
                dataset_uuid = datasetid$PWBImportID
)

# Fetching the first 3 rows of data
ImportData$frame %>% head(3)
```

```{r}
CustomData <- dc$fetch_data(
                study_uuid = ExciterStudy$ExciterStudyId,
                study_environment_uuid = ExciterStudy$ExciterPRODEnvID,
                dataset_uuid = datasetid$ExciterCustomID
)

# Fetching the first 3 rows of data
CustomData$frame %>% head(3)
```

```{r}
# MATERIALIZE LOCALLY: bring the data into memory as a data.frame
# collect() should return the entirety of the dataset 

Derdf = Derdata$frame %>% collect()
Importdf = ImportData$frame %>% collect()
Customdf = CustomData$frame %>% collect()
```

```{r}
# Consider fetching the first few rows of a dataset by using %>% head() if the dataset is extremely large

RAVEdf = RAVEdata$frame %>% head()
```

### Data Transformation Example Using Dplyr

#### Data transformation using native dplyr capability in R

Materialize the data into the client side memory as a R dataframe.

If you have limited memory allocation, we recommend working on a limited set of records to reduce development time, and then remove record limit during recurring execution.

If you receive an error indicating that you are running out of memory, please reach out to your R IDE provider to increase the memory allocation.

#### Set up: Using dplyr to perform data transformation on materialized data frame

These functions are not provided by the `dataconnect` library; below are just examples of how common R libraries can be used with the `dataconnect` library. For details on how these libraries can be used, please consult the respective library documentation.

```{r dplyr-basic}
# Pivot Derdf as pivotDF
pivotDF <- Derdf %>%
  rename(
    HCT_result = HCT,
    plat_result = PLAT,
    wbc_result = WBC,
    HCT_unit = HCT_UNIT,
    plat_unit = PLAT_UNIT,
    wbc_unit = WBC_UNIT
  ) %>%
  pivot_longer(
    cols = -c(patient_id, site_id, LBTIM),
    names_to = c("lab_test", ".value"),
    names_sep = "_"
  ) %>%
  rename(
    lab_result = result,
    lab_unit = unit
  )

# Union the datasets together (pivotDF, Importdf) as unionDF
pivotdf_renamed <- pivotDF %>%
  rename(
    subjid = patient_id,
    siteid = site_id,
    lbtest = lab_test,
    lbresn = lab_result,
    lbresu = lab_unit
  )
unionDF <- bind_rows(Importdf, pivotdf_renamed)

# Join the datasets together (unionDF, Customdf) as publishDF
x = Importdf
y = unionDF
publishDF <- full_join(
  x,
  y %>% select(subjid, 
               siteid, 
               visitnum, 
               -any_of(
                 setdiff(
                   names(x),
                   c("subjid", "siteid", "visitnum")
                   )
                 )
               ),
  by = c("subjid" = "subjid", "siteid" = "siteid", "visitnum" = "visitnum")
)
```

### Publishing

Set up your project token where the resulting dataset (i.e., publishDF) will be published to. 
Please make sure it is published to the correct study environment and project. 
It is recommended to use dry_publish function to validate the result first before publishing the resulting dataset back to Medidata Data Connect.

```{r}
# The project token is generated in the Data Connect Transformation Custom Code Project

myProjectToken = "projecttoken"
```

#### Validate the dataset to be published

```{r}
# Validating the published dataset; comment out when set on a recurring schedule
dc$dry_publish(
  project_token = myProjectToken,
  dataset_name = "projectname",
  key_columns = list ("field1","field2", "field3"),
  source_datasets = list(datasetid$PWBDerID, datasetid$PWBImportID, datasetid$PWBRaveID),
  data = publishDF
)
```

#### Publish

```{r}
dc$publish(
  project_token = myProjectToken,
  dataset_name = "projectname",
  key_columns = list ("field1","field2", "field3"),
  source_datasets = list(datasetid$PWBDerID, datasetid$PWBImportID, datasetid$PWBRaveID),
  data = publishDF
)
```
